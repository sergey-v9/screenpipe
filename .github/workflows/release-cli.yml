# # Run for macOS
# act -W .github/workflows/release-cli.yml --container-architecture linux/amd64 -j build-macos -P macos-latest=-self-hosted

# act -W .github/workflows/release-cli.yml --container-architecture linux/amd64 -j build-linux -P ubuntu-latest=catthehacker/ubuntu:act-latest --secret GITHUB_TOKEN=$(cat .env | grep GITHUB_TOKEN | tail -n 1 | cut -d '=' -f 2)

name: Release CLI

on:
  push:
    tags:
      - "v*"
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_commit:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: check
        run: |
          # Always release on tag push or manual trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will release"
            exit 0
          fi

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Tag push - will release"
            exit 0
          fi

          # For branch pushes, check commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Release CLI when app is released or explicitly requested
          # Match: "release-app", "release-cli", "Bump app to vX.Y.Z", "Bump CLI to vX.Y.Z"
          if echo "$COMMIT_MSG" | grep -qiE "(release-app|release-cli|Bump app to v|Bump CLI to v)"; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Commit message contains release trigger - will release"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No release trigger found - skipping"
          fi

  build-windows:
    needs: check_commit
    if: needs.check_commit.outputs.should_release == 'true'
    runs-on: windows-2019
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        run: |
          Invoke-WebRequest https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe -OutFile rustup-init.exe
          .\rustup-init.exe -y

      - name: Install 7zip
        shell: powershell
        run: |
          $7zipUrl = "https://7-zip.org/a/7z2301-x64.exe"
          $7zipInstaller = "7z-installer.exe"
          Invoke-WebRequest -Uri $7zipUrl -OutFile $7zipInstaller
          Start-Process -FilePath .\$7zipInstaller -Args "/S" -Wait
          Remove-Item $7zipInstaller
          # Add 7zip to PATH and make it persistent for subsequent steps
          echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          # Verify installation
          & "C:\Program Files\7-Zip\7z.exe" i

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "10.0"

      # sccache disabled temporarily due to GitHub Actions cache outage
      # - name: Setup sccache
      #   uses: mozilla-actions/sccache-action@v0.0.7
      #   with:
      #     version: "v0.8.2"

      # - name: Configure sccache
      #   shell: bash
      #   run: |
      #     echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
      #     echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: windows-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build CLI
        env:
          CARGO_PROFILE_RELEASE_STRIP: "none"
          CARGO_PROFILE_RELEASE_PANIC: "abort"
          CARGO_PROFILE_RELEASE_INCREMENTAL: "false"
          RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=/LTCG"
        run: |
          cargo build --release --target x86_64-pc-windows-msvc

      - name: Upload debug symbols to Sentry
        shell: powershell
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: mediar
        run: |
          Invoke-WebRequest -Uri "https://release-registry.services.sentry.io/apps/sentry-cli/latest?response=download&arch=x86_64&platform=Windows&package=sentry-cli" -OutFile sentry-cli.exe
          .\sentry-cli.exe debug-files upload --org $env:SENTRY_ORG --project screenpipe-cli target/x86_64-pc-windows-msvc/release/

      - name: Set version
        shell: pwsh
        run: |
          $VERSION = if ($env:GITHUB_REF -match "refs/tags/*") {
              $env:GITHUB_REF -replace "refs/tags/v", ""
          } else {
              # Read version from workspace Cargo.toml
              $cargoContent = Get-Content "Cargo.toml" -Raw
              if ($cargoContent -match 'version = "([^"]+)"') {
                  $matches[1]
              } else {
                  "0.0.0"
              }
          }
          if ([string]::IsNullOrEmpty($VERSION)) {
              $VERSION = "0.0.0"
          }
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append
          "Set version to: $VERSION"

      - name: Create deployment package
        shell: pwsh
        run: |
          $packageDir = "screenpipe-${{ env.VERSION }}-x86_64-pc-windows-msvc"
          New-Item -Path "$packageDir/bin" -ItemType Directory -Force
          Copy-Item "target/x86_64-pc-windows-msvc/release/screenpipe.exe" "$packageDir/bin/"
          Copy-Item "target/x86_64-pc-windows-msvc/release/onnxruntime.dll" "$packageDir/bin/"
          7z a "$packageDir.zip" "./$packageDir/*"

      - name: Calculate SHA256
        shell: pwsh
        run: |
          $hash = Get-FileHash "screenpipe-${{ env.VERSION }}-x86_64-pc-windows-msvc.zip" -Algorithm SHA256
          "WIN_SHA256=$($hash.Hash)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-windows
          path: screenpipe-*.zip

  release:
    runs-on: ubuntu-latest
    needs: [ build-windows ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # Use tag version if triggered by tag
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Read version from workspace Cargo.toml
            VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          fi
          if [[ -z "$VERSION" ]]; then
            VERSION="0.0.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Set version to: $VERSION"

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Create or update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${{ env.VERSION }} --title ${{ env.VERSION }} --generate-notes || true
          for file in artifacts/screenpipe-windows/screenpipe-*.zip; do
            if [ -f "$file" ]; then
              gh release upload v${{ env.VERSION }} "$file" --clobber
            else
              echo "Warning: $file not found"
            fi
          done
